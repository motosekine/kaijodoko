<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会場登録 - 管理者ページ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-icons@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4 min-h-screen">

    <div class="container bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
        <!-- ヘッダー -->
        <header class="text-center space-y-2">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800">
                会場登録 - 管理者ページ
            </h1>
            <p class="text-gray-600 md:text-lg">
                新しい会場を登録できます。
            </p>
        </header>

        <!-- パスワード認証フォーム -->
        <div id="passwordForm">
            <h2 class="text-xl font-bold text-gray-800 text-center mb-4">パスワードを入力してください</h2>
            <div class="flex flex-col gap-4">
                <input type="password" id="adminPassword" placeholder="パスワード" class="w-full px-4 py-2 rounded-md border-2 border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all shadow-sm">
                <button id="authBtn" class="w-full bg-indigo-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-indigo-600 transition-colors">
                    認証
                </button>
            </div>
        </div>

        <!-- 登録フォーム -->
        <div id="registrationForm" class="hidden bg-gray-50 rounded-xl p-6 space-y-4 shadow-inner">
            <div>
                <label for="formalName" class="block text-sm font-medium text-gray-700">正式名称 <span class="text-red-500">*</span></label>
                <input type="text" id="formalName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="nickname" class="block text-sm font-medium text-gray-700">略称（愛称）</label>
                <input type="text" id="nickname" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700">住所 <span class="text-red-500">*</span></label>
                <input type="text" id="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="mapUrl" class="block text-sm font-medium text-gray-700">地図URL (Googleマップの共有リンク)</label>
                <p class="mt-1 text-xs text-gray-500">地図URLの入力が無い場合は、入力された住所から自動的に登録されます</p>
                <input type="url" id="mapUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <button id="submitBtn" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
                登録する
            </button>
        </div>
        
        <!-- ローディング画面 -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
        </div>
    </div>

    <footer class="mt-8 text-center text-gray-500 text-sm w-full p-4">
        &copy; 2025 motofumi.s
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Vercelの環境変数からSupabaseの情報を取得
            const SUPABASE_URL = process.env.SUPABASE_URL;
            const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;
            const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Vercelの環境変数からパスワードを取得
            const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD;

            const passwordForm = document.getElementById('passwordForm');
            const adminPasswordInput = document.getElementById('adminPassword');
            const authBtn = document.getElementById('authBtn');
            const registrationForm = document.getElementById('registrationForm');
            const submitBtn = document.getElementById('submitBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // パスワード認証
            authBtn.addEventListener('click', () => {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    passwordForm.classList.add('hidden');
                    registrationForm.classList.remove('hidden');
                    alert('認証に成功しました。会場を登録できます。');
                } else {
                    alert('パスワードが間違っています。');
                }
            });

            // 登録ボタンのクリックイベント
            submitBtn.addEventListener('click', async () => {
                const formalName = document.getElementById('formalName').value;
                const nickname = document.getElementById('nickname').value;
                const address = document.getElementById('address').value;
                const mapUrl = document.getElementById('mapUrl').value;
                
                if (!formalName || !address) {
                    alert('正式名称と住所は必須です。');
                    return;
                }

                loadingOverlay.style.display = 'flex';

                const { data, error } = await supabase
                    .from('venues')
                    .insert([
                        {
                            formal_name: formalName,
                            nickname: nickname,
                            address: address,
                            map_url: mapUrl
                        }
                    ]);

                if (error) {
                    console.error("会場データの登録に失敗しました:", error);
                    alert("会場データの登録に失敗しました。後でもう一度お試しください。");
                } else {
                    alert('会場情報が正常に登録されました。');
                    // フォームをリセット
                    document.getElementById('formalName').value = '';
                    document.getElementById('nickname').value = '';
                    document.getElementById('address').value = '';
                    document.getElementById('mapUrl').value = '';
                }
                
                loadingOverlay.style.display = 'none';
            });
        });
    </script>
</body>
</html>
